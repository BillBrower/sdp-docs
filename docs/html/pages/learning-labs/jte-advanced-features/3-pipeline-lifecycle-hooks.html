

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Pipeline Lifecycle Hooks &mdash; Solutions Delivery Platform  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Multi-Method Steps" href="4-multimethod-steps.html" />
    <link rel="prev" title="Default Step Implementation" href="2-default-step-implementation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Solutions Delivery Platform
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Components</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://jenkinsci.github.io/templating-engine-plugin">Jenkins Templating Engine</a></li>
<li class="toctree-l1"><a class="reference external" href="https://boozallen.github.io/sdp-libraries">Pipeline Libraries</a></li>
</ul>
<p class="caption"><span class="caption-text">Deployment Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../deployment-guides/openshift/index.html">OpenShift</a></li>
</ul>
<p class="caption"><span class="caption-text">Learning Labs</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../try-it-out/docs/index.html">Try It Out</a></li>
<li class="toctree-l1"><a class="reference internal" href="../local-development/index.html">Local Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jte-the-basics/index.html">JTE: The Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jte-primitives/index.html">JTE: Pipeline Primitives</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">JTE: Advanced Features</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="1-prerequisites.html">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="2-default-step-implementation.html">Default Step Implementation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Pipeline Lifecycle Hooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="4-multimethod-steps.html">Multi-Method Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="5-summary.html">Summary</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">How-To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../how-to/helm-multitenancy.html">Helm Multitenancy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how-to/add_jenkins_credentials.html">Add Credentials to Jenkins</a></li>
<li class="toctree-l1"><a class="reference external" href="https://help.github.com/articles/creating-a-new-organization-from-scratch/">Create a GitHub Organization</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.twistlock.com/2018/05/08/securing-containers-red-hat-openshift-twistlock-deployment-script/">Deploy Twistlock to OpenShift</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Solutions Delivery Platform</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">JTE: Advanced Features</a> &raquo;</li>
        
      <li>Pipeline Lifecycle Hooks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/pages/learning-labs/jte-advanced-features/3-pipeline-lifecycle-hooks.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="pipeline-lifecycle-hooks">
<span id="jte-advanced-features-pipeline-lifecycle-hooks"></span><h1>Pipeline Lifecycle Hooks<a class="headerlink" href="#pipeline-lifecycle-hooks" title="Permalink to this headline">¶</a></h1>
<p>There can be interdependent functionalities that presented a challenge to the
Jenkins Templating Engine.</p>
<p>For example, let’s say we wanted to introduce Splunk monitoring by sending events
as part of the pipeline?</p>
<p>How do you:</p>
<ol class="arabic simple">
<li>Maintain a clean, easy to read Pipeline Template?</li>
<li>Maintain a separation of duties between libraries as to not hardcode a Splunk integration into every library step?</li>
</ol>
<p>It would be great if there was a seemless way to inject functionality in response to different phases
of the pipeline without having to tightly couple that functionality to existing library steps or
Pipeline Templates.</p>
<p>You can!  The Jenkins Templating Engine has a neat feature we call Pipeline Lifecycle Hooks that
were made for just these situations.</p>
<p>We’ll walk through the Splunk use case to demonstrate this functionality.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Read the <a class="reference external" href="https://jenkinsci.github.io/templating-engine-plugin/pages/Library_Development/lifecycle_hooks.html">entire pipeline lifecycle hook documentation</a>.</p>
</div>
<div class="section" id="create-a-splunk-library">
<h2>Create a Splunk Library<a class="headerlink" href="#create-a-splunk-library" title="Permalink to this headline">¶</a></h2>
<p>Methods defined within steps are able to register themselves to correspond to specific lifecycle events
via annotations.  As such, these steps are typically not invoked directly by other steps or from the
Pipeline Template.</p>
<p>Because of this, the name of the step is inconsequential but cannot conflict with other step names that
are loaded.</p>
<p>Therefore, we typically recommend following a naming convention of prepending the step name with the
library name to namespace the hooks.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">It doesn’t matter what you call steps that only contain Pipeline Lifecycle Hook annotated methods.
But to avoid collisions of everyone naming their hook steps <code class="docutils literal notranslate"><span class="pre">beforeStep.groovy</span></code> - we recommend
<code class="docutils literal notranslate"><span class="pre">&lt;libraryName&gt;_&lt;action&gt;</span></code> as we’ll demonstrate in this lab.</p>
</div>
<div class="section" id="notify-of-pipeline-start">
<h3>Notify of Pipeline Start<a class="headerlink" href="#notify-of-pipeline-start" title="Permalink to this headline">¶</a></h3>
<p>Within the same Library Source created during JTE: The Basics create a step called
<code class="docutils literal notranslate"><span class="pre">splunk_pipeline_start.groovy</span></code>:</p>
<p><strong>libraries/splunk/splunk_pipeline_start.groovy</strong>:</p>
<div class="code groovy highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Init</span>
<span class="n">void</span> <span class="n">call</span><span class="p">(</span><span class="n">context</span><span class="p">){</span>
    <span class="n">println</span> <span class="s2">&quot;Splunk: beginning of the pipeline!&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Breaking down this step, the <code class="docutils literal notranslate"><span class="pre">&#64;Init</span></code> registers the <code class="docutils literal notranslate"><span class="pre">call</span></code> method defined in this
step to be invoked at the beginning of the pipeline.</p>
<p>This <code class="docutils literal notranslate"><span class="pre">call</span></code> method takes a Map as an input parameter.  This argument represents the
pipeline context and will let you know the pipeline’s current status as well as the
library and step that the hook is responding to.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This input parameter to annotated steps is typically called <code class="docutils literal notranslate"><span class="pre">context</span></code> but can
be called anything.</p>
<p class="last">Since Groovy is a dynamically typed language, this input parameter does not have
to be given a class.</p>
</div>
</div>
<div class="section" id="update-the-pipeline-configuration">
<h3>Update the Pipeline Configuration<a class="headerlink" href="#update-the-pipeline-configuration" title="Permalink to this headline">¶</a></h3>
<p>In the Pipeline job again, update the Pipeline Configuration to load the <code class="docutils literal notranslate"><span class="pre">splunk</span></code>
library we just created.</p>
<div class="code groovy highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libraries</span><span class="p">{</span>
    <span class="n">maven</span>
    <span class="n">sonarqube</span>
    <span class="n">ansible</span>
    <span class="n">splunk</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That’s it! Just by loading the library, JTE will be able to find the methods within steps
annotated with a Pipeline Lifecycle Hook.</p>
<p>Run the Pipeline job and you should see output in the logs similar to:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[JTE] [@Init - splunk/splunk_pipeline_start.call]
[Pipeline] echo
Splunk: beginning of the pipeline!
</pre></div>
</div>
</div>
<div class="section" id="add-before-and-after-step-execution-hooks">
<h3>Add Before and After Step Execution Hooks<a class="headerlink" href="#add-before-and-after-step-execution-hooks" title="Permalink to this headline">¶</a></h3>
<p>Let’s add some hooks that inject themselves both before and after each step is executed in the pipeline.</p>
<p><strong>libraries/splunk/splunk_step_watcher.groovy</strong>:</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@BeforeStep</span>
<span class="n">void</span> <span class="n">before</span><span class="p">(</span><span class="n">context</span><span class="p">){</span>
<span class="n">println</span> <span class="s2">&quot;Splunk: running before the $</span><span class="si">{context.library}</span><span class="s2"> library&#39;s $</span><span class="si">{context.step}</span><span class="s2"> step&quot;</span>
<span class="p">}</span>

<span class="nd">@AfterStep</span>
<span class="n">void</span> <span class="n">after</span><span class="p">(</span><span class="n">context</span><span class="p">){</span>
<span class="n">println</span> <span class="s2">&quot;Splunk: running after the $</span><span class="si">{context.library}</span><span class="s2"> library&#39;s $</span><span class="si">{context.step}</span><span class="s2"> step&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Here, we’re defining two different methods in a single step.  In the next section we’ll talk
about this in more detail.</p>
<p class="last">For right now, the important piece is that the method’s have the <code class="docutils literal notranslate"><span class="pre">&#64;BeforeStep</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;AfterStep</span></code>
annotations.</p>
</div>
<p>Rerunning the pipeline, we can now see these hooks get executed:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[Pipeline] Start of Pipeline
[JTE] Pipeline Configuration Modifications (show)
[JTE] Loading Library maven (show)
[JTE] Library maven does not have a configuration file.
[JTE] Loading Library sonarqube (show)
[JTE] Library sonarqube does not have a configuration file.
[JTE] Loading Library ansible (show)
[JTE] Library ansible does not have a configuration file.
[JTE] Loading Library splunk (show)
[JTE] Library splunk does not have a configuration file.
[JTE] Creating step unit_test from the default step implementation.
[JTE] Obtained Pipeline Template from job configuration
[Pipeline] node
Running on Jenkins in /var/jenkins_home/workspace/single-job
[Pipeline] {
[Pipeline] writeFile
[Pipeline] archiveArtifacts
Archiving artifacts
[Pipeline] }
[Pipeline] // node
[JTE] [@Init - splunk/splunk_pipeline_start.call]
[Pipeline] echo
Splunk: beginning of the pipeline!
[JTE] [Stage - continuous_integration]
[JTE] [@BeforeStep - splunk/splunk_step_watcher.before]
[Pipeline] echo
Splunk: running before the Default Step Implementation library&#39;s unit_test step
[JTE] [Step - Default Step Implementation/unit_test.call()]
[Pipeline] stage
[Pipeline] { (Unit Test)
[Pipeline] node
Running on Jenkins in /var/jenkins_home/workspace/single-job
[Pipeline] {
[Pipeline] isUnix
[Pipeline] sh
+ docker inspect -f . maven
.
[Pipeline] withDockerContainer
Jenkins seems to be running inside container cc7140d4fb91bef940e2fabe7225dcbcc9b44a3a5e17ee703b8fcbe42e53a17c
$ docker run -t -d -u 0:0 -w /var/jenkins_home/workspace/single-job --volumes-from cc7140d4fb91bef940e2fabe7225dcbcc9b44a3a5e17ee703b8fcbe42e53a17c -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** maven cat
$ docker top ead0198246fc908dfb815941ae07227b849ab092b49c9f9db59c46b24718b9d8 -eo pid,comm
[Pipeline] {
[Pipeline] unstash
[Pipeline] sh
+ mvn -v
Apache Maven 3.6.2 (40f52333136460af0dc0d7232c0dc0bcf0d9e117; 2019-08-27T15:06:16Z)
Maven home: /usr/share/maven
Java version: 11.0.5, vendor: Oracle Corporation, runtime: /usr/local/openjdk-11
Default locale: en, platform encoding: UTF-8
OS name: &quot;linux&quot;, version: &quot;4.9.125-linuxkit&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot;
[Pipeline] }
$ docker stop --time=1 ead0198246fc908dfb815941ae07227b849ab092b49c9f9db59c46b24718b9d8
$ docker rm -f ead0198246fc908dfb815941ae07227b849ab092b49c9f9db59c46b24718b9d8
[Pipeline] // withDockerContainer
[Pipeline] }
[Pipeline] // node
[Pipeline] }
[Pipeline] // stage
[JTE] [@AfterStep - splunk/splunk_step_watcher.after]
[Pipeline] echo
Splunk: running after the Default Step Implementation library&#39;s unit_test step
[JTE] [@BeforeStep - splunk/splunk_step_watcher.before]
[Pipeline] echo
Splunk: running before the maven library&#39;s build step
[JTE] [Step - maven/build.call()]
[Pipeline] stage
[Pipeline] { (Maven: Build)
[Pipeline] echo
build from the maven library
[Pipeline] }
[Pipeline] // stage
[JTE] [@AfterStep - splunk/splunk_step_watcher.after]
[Pipeline] echo
Splunk: running after the maven library&#39;s build step
[JTE] [@BeforeStep - splunk/splunk_step_watcher.before]
[Pipeline] echo
Splunk: running before the sonarqube library&#39;s static_code_analysis step
[JTE] [Step - sonarqube/static_code_analysis.call()]
[Pipeline] stage
[Pipeline] { (SonarQube: Static Code Analysis)
[Pipeline] echo
static code analysis from the sonarqube library
[Pipeline] }
[Pipeline] // stage
[JTE] [@AfterStep - splunk/splunk_step_watcher.after]
[Pipeline] echo
Splunk: running after the sonarqube library&#39;s static_code_analysis step
[JTE] [@BeforeStep - splunk/splunk_step_watcher.before]
[Pipeline] echo
Splunk: running before the ansible library&#39;s deploy_to step
[JTE] [Step - ansible/deploy_to.call(ApplicationEnvironment)]
[Pipeline] stage
[Pipeline] { (Deploy To: dev)
[Pipeline] echo
performing a deployment through ansible..
[Pipeline] echo
deploying to 0.0.0.1
[Pipeline] echo
deploying to 0.0.0.2
[Pipeline] }
[Pipeline] // stage
[JTE] [@AfterStep - splunk/splunk_step_watcher.after]
[Pipeline] echo
Splunk: running after the ansible library&#39;s deploy_to step
[Pipeline] timeout
Timeout set to expire in 5 min 0 sec
[Pipeline] {
[Pipeline] input
Approve the deployment?
Proceed or Abort
Approved by admin
[Pipeline] }
[Pipeline] // timeout
[JTE] [@BeforeStep - splunk/splunk_step_watcher.before]
[Pipeline] echo
Splunk: running before the ansible library&#39;s deploy_to step
[JTE] [Step - ansible/deploy_to.call(ApplicationEnvironment)]
[Pipeline] stage
[Pipeline] { (Deploy To: Production)
[Pipeline] echo
performing a deployment through ansible..
[Pipeline] echo
deploying to 0.0.1.1
[Pipeline] echo
deploying to 0.0.1.2
[Pipeline] echo
deploying to 0.0.1.3
[Pipeline] echo
deploying to 0.0.1.4
[Pipeline] }
[Pipeline] // stage
[JTE] [@AfterStep - splunk/splunk_step_watcher.after]
[Pipeline] echo
Splunk: running after the ansible library&#39;s deploy_to step
[Pipeline] End of Pipeline
Finished: SUCCESS
</pre></div>
</div>
</div>
<div class="section" id="notify-of-end-of-pipeline-execution">
<h3>Notify of End of Pipeline Execution<a class="headerlink" href="#notify-of-end-of-pipeline-execution" title="Permalink to this headline">¶</a></h3>
<p>Let’s try out one more hook to get executed when the pipeline has finished:</p>
<p><strong>libraries/splunk/splunk_pipeline_end.groovy</strong>:</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@CleanUp</span>
<span class="n">void</span> <span class="n">call</span><span class="p">(</span><span class="n">context</span><span class="p">){</span>
    <span class="n">println</span> <span class="s2">&quot;Splunk: end of the pipeline!&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Run the pipeline again and you should see logs similar to:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[Pipeline] Start of Pipeline
[JTE] Pipeline Configuration Modifications (show)
[JTE] Loading Library maven (show)
[JTE] Library maven does not have a configuration file.
[JTE] Loading Library sonarqube (show)
[JTE] Library sonarqube does not have a configuration file.
[JTE] Loading Library ansible (show)
[JTE] Library ansible does not have a configuration file.
[JTE] Loading Library splunk (show)
[JTE] Library splunk does not have a configuration file.
[JTE] Creating step unit_test from the default step implementation.
[JTE] Obtained Pipeline Template from job configuration
[Pipeline] node
Running on Jenkins in /var/jenkins_home/workspace/single-job
[Pipeline] {
[Pipeline] writeFile
[Pipeline] archiveArtifacts
Archiving artifacts
[Pipeline] }
[Pipeline] // node
[JTE] [@Init - splunk/splunk_pipeline_start.call]
[Pipeline] echo
Sending Splunk event for beginning of the pipeline!
[JTE] [Stage - continuous_integration]
[JTE] [@BeforeStep - splunk/splunk_step_watcher.before]
[Pipeline] echo
Splunk: running before the Default Step Implementation library&#39;s unit_test step
[JTE] [Step - Default Step Implementation/unit_test.call()]
[Pipeline] stage
[Pipeline] { (Unit Test)
[Pipeline] node
Running on Jenkins in /var/jenkins_home/workspace/single-job
[Pipeline] {
[Pipeline] isUnix
[Pipeline] sh
+ docker inspect -f . maven
.
[Pipeline] withDockerContainer
Jenkins seems to be running inside container cc7140d4fb91bef940e2fabe7225dcbcc9b44a3a5e17ee703b8fcbe42e53a17c
$ docker run -t -d -u 0:0 -w /var/jenkins_home/workspace/single-job --volumes-from cc7140d4fb91bef940e2fabe7225dcbcc9b44a3a5e17ee703b8fcbe42e53a17c -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** maven cat
$ docker top 109ac04fcc911f8df3ca5281720f50886497045230b43ae2a6ca4e9b1b0b1271 -eo pid,comm
[Pipeline] {
[Pipeline] unstash
[Pipeline] sh
+ mvn -v
Apache Maven 3.6.2 (40f52333136460af0dc0d7232c0dc0bcf0d9e117; 2019-08-27T15:06:16Z)
Maven home: /usr/share/maven
Java version: 11.0.5, vendor: Oracle Corporation, runtime: /usr/local/openjdk-11
Default locale: en, platform encoding: UTF-8
OS name: &quot;linux&quot;, version: &quot;4.9.125-linuxkit&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot;
[Pipeline] }
$ docker stop --time=1 109ac04fcc911f8df3ca5281720f50886497045230b43ae2a6ca4e9b1b0b1271
$ docker rm -f 109ac04fcc911f8df3ca5281720f50886497045230b43ae2a6ca4e9b1b0b1271
[Pipeline] // withDockerContainer
[Pipeline] }
[Pipeline] // node
[Pipeline] }
[Pipeline] // stage
[JTE] [@AfterStep - splunk/splunk_step_watcher.after]
[Pipeline] echo
Splunk: running after the Default Step Implementation library&#39;s unit_test step
[JTE] [@BeforeStep - splunk/splunk_step_watcher.before]
[Pipeline] echo
Splunk: running before the maven library&#39;s build step
[JTE] [Step - maven/build.call()]
[Pipeline] stage
[Pipeline] { (Maven: Build)
[Pipeline] echo
build from the maven library
[Pipeline] }
[Pipeline] // stage
[JTE] [@AfterStep - splunk/splunk_step_watcher.after]
[Pipeline] echo
Splunk: running after the maven library&#39;s build step
[JTE] [@BeforeStep - splunk/splunk_step_watcher.before]
[Pipeline] echo
Splunk: running before the sonarqube library&#39;s static_code_analysis step
[JTE] [Step - sonarqube/static_code_analysis.call()]
[Pipeline] stage
[Pipeline] { (SonarQube: Static Code Analysis)
[Pipeline] echo
static code analysis from the sonarqube library
[Pipeline] }
[Pipeline] // stage
[JTE] [@AfterStep - splunk/splunk_step_watcher.after]
[Pipeline] echo
Splunk: running after the sonarqube library&#39;s static_code_analysis step
[JTE] [@BeforeStep - splunk/splunk_step_watcher.before]
[Pipeline] echo
Splunk: running before the ansible library&#39;s deploy_to step
[JTE] [Step - ansible/deploy_to.call(ApplicationEnvironment)]
[Pipeline] stage
[Pipeline] { (Deploy To: dev)
[Pipeline] echo
performing a deployment through ansible..
[Pipeline] echo
deploying to 0.0.0.1
[Pipeline] echo
deploying to 0.0.0.2
[Pipeline] }
[Pipeline] // stage
[JTE] [@AfterStep - splunk/splunk_step_watcher.after]
[Pipeline] echo
Splunk: running after the ansible library&#39;s deploy_to step
[Pipeline] timeout
Timeout set to expire in 5 min 0 sec
[Pipeline] {
[Pipeline] input
Approve the deployment?
Proceed or Abort
Approved by admin
[Pipeline] }
[Pipeline] // timeout
[JTE] [@BeforeStep - splunk/splunk_step_watcher.before]
[Pipeline] echo
Splunk: running before the ansible library&#39;s deploy_to step
[JTE] [Step - ansible/deploy_to.call(ApplicationEnvironment)]
[Pipeline] stage
[Pipeline] { (Deploy To: Production)
[Pipeline] echo
performing a deployment through ansible..
[Pipeline] echo
deploying to 0.0.1.1
[Pipeline] echo
deploying to 0.0.1.2
[Pipeline] echo
deploying to 0.0.1.3
[Pipeline] echo
deploying to 0.0.1.4
[Pipeline] }
[Pipeline] // stage
[JTE] [@AfterStep - splunk/splunk_step_watcher.after]
[Pipeline] echo
Splunk: running after the ansible library&#39;s deploy_to step
[JTE] [@CleanUp - splunk/splunk_pipeline_end.call]
[Pipeline] echo
Splunk: end of the pipeline!
[Pipeline] End of Pipeline
</pre></div>
</div>
</div>
</div>
<div class="section" id="restricting-hook-execution">
<h2>Restricting Hook Execution<a class="headerlink" href="#restricting-hook-execution" title="Permalink to this headline">¶</a></h2>
<p>What if we only wanted to execute the <code class="docutils literal notranslate"><span class="pre">&#64;AfterStep</span></code> hook to be executed
after the <code class="docutils literal notranslate"><span class="pre">static_code_analysis</span></code> step?</p>
<p>Pipeline Lifecycle Hook annotations accept a <strong>Closure</strong> parameter.  This
Closure will be executed, and if the return of the Closure is non-false the
step will be executed.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Remember: Groovy has implicit return statements.  The last statement made
becomes the return object by default.</p>
</div>
<p>We call this functionality <strong>Conditional Hook Execution</strong>.</p>
<div class="section" id="update-the-afterstep-annotation">
<h3>Update the <code class="docutils literal notranslate"><span class="pre">&#64;AfterStep</span></code> Annotation<a class="headerlink" href="#update-the-afterstep-annotation" title="Permalink to this headline">¶</a></h3>
<p>Let’s see it in action.</p>
<p>Update the <code class="docutils literal notranslate"><span class="pre">&#64;AfterStep</span></code> created in <strong>libraries/splunk/pipeline_step_watcher.groovy</strong> to:</p>
<div class="code groovy highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@AfterStep</span><span class="p">({</span> <span class="n">context</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="s2">&quot;static_code_analysis&quot;</span><span class="p">)</span> <span class="p">})</span>
</pre></div>
</div>
<p>Rerun the pipeline and notice that now, the hook has been restricted to only run after the desired
step.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">When the <code class="docutils literal notranslate"><span class="pre">Closure</span></code> parameter is invoked, it will have access to the <code class="docutils literal notranslate"><span class="pre">context</span></code> variable that
is passed to the step itself as well as the library configuration that is stored via the <code class="docutils literal notranslate"><span class="pre">config</span></code>
variable.</p>
</div>
</div>
<div class="section" id="taking-it-a-step-further">
<h3>Taking It A Step Further<a class="headerlink" href="#taking-it-a-step-further" title="Permalink to this headline">¶</a></h3>
<p>It would be even better if we could externalize the configuration of exactly which steps
the <code class="docutils literal notranslate"><span class="pre">&#64;AfterStep</span></code> hook should be triggered.</p>
<p>To do this, update the <code class="docutils literal notranslate"><span class="pre">&#64;AfterStep</span></code> annotation again to be:</p>
<div class="code groovy highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@AfterStep</span><span class="p">({</span> <span class="n">context</span><span class="o">.</span><span class="n">step</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">afterSteps</span> <span class="p">})</span>
</pre></div>
</div>
<p>Now, we can conditionally execute the hook by checking if the name of the step that was just executed
is in an array called <code class="docutils literal notranslate"><span class="pre">afterSteps</span></code> defined as part of the <code class="docutils literal notranslate"><span class="pre">splunk</span></code> library in the Pipeline Configuration!</p>
<p>Update the <code class="docutils literal notranslate"><span class="pre">splunk</span></code> portion of the Pipeline Configuration to:</p>
<div class="code groovy highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libraries</span><span class="p">{</span>
    <span class="n">maven</span>
    <span class="n">sonarqube</span>
    <span class="n">ansible</span>
    <span class="n">splunk</span><span class="p">{</span>
        <span class="n">afterSteps</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;static_code_analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;unit_test&quot;</span>  <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Run the pipeline again and notice that the hook was only executed after the steps defined in the Pipeline Configuration.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Conditional Execution Closure Parameters can be passed to any Pipeline Lifecycle Hook annotation.
As long as the Closure returns a non-false value, the hook will be invoked.</p>
</div>
<p><strong>Remember to read through the `Pipeline Lifecycle Hook documentation &lt;https://jenkinsci.github.io/templating-engine-plugin/pages/Library_Development/lifecycle_hooks.html&gt;`_
to see all the annotations available.</strong></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="4-multimethod-steps.html" class="btn btn-neutral float-right" title="Multi-Method Steps" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="2-default-step-implementation.html" class="btn btn-neutral float-left" title="Default Step Implementation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Booz Allen Hamilton

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-144247959-1', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>